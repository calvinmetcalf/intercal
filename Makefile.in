#
# Productions for the INTERCAL distribution
#
VERSION=@PACKAGE_VERSION@

# Common prefix for machine-independent installed files.
prefix = @prefix@
# Common prefix for machine-dependent installed files.
exec_prefix = @exec_prefix@

# Directory in which to install binaries.
bindir = @bindir@
# Directory in which to install libraries.
libdir = @libdir@
# Directory to install data files.
datadir = @datadir@/intercal-@PACKAGE_VERSION@
# Directory to install the include files in.
incdir = @includedir@/intercal-@PACKAGE_VERSION@

# Program to install binaries
INSTALL_PROGRAM = @INSTALL_PROGRAM@
# Program to install the man page.
INSTALL_DATA = @INSTALL_DATA@
# Generic install program.
INSTALL = @INSTALL@

# This can be overridden from the command line
DESTDIR=

# Location of GNU GPL. This will be automatically copied if not required during install.
# If not using install, change this to any copy of the GNU GPL that exists on your system.
# This is required because the yuk debugger reads commands interactively, and so must be
# able to display a copy of the GPL on demand. This is only possible if yuk can find a copy.
# If you want to delete or move the distribution files, then you will have to move COPYING
# to another directory; otherwise, you can aim this at COPYING.
# It's also possible to aim this at a copy of COPYING from another GPL program.
copyloc = ${DESTDIR}${datadir}/COPYING.txt

CC = @CC@
CFLAGS = @CFLAGS@ -DICKINCLUDEDIR=\"$(incdir)\" -DICKLIBDIR=\"$(datadir)\" -DICKBINDIR=\"$(bindir)\" -DYYDEBUG -DYUKCOPYLOC=\"$(copyloc)\" -O2 -W -Wall -I./src -I./temp
LDFLAGS = @LDFLAGS@
LEX = @LEX@
LEXFLAGS=
YACC = @YACC@
YACCFLAGS = -d # -t

LOADLIBS = @LIBS@ @INTLLIBS@ @LEXLIB@

CSOURCES = src/parser.y src/lexer.l src/feh2.c src/dekludge.c src/lose.c src/fiddle.c src/perpet.c src/unravel.c
ISOURCES = src/cesspool.c src/arrgghh.c src/ick-wrap.c src/numerals.c
YSOURCES = src/yuk.c
HEADERS = src/ick.h src/lose.h src/sizes.h src/abcess.h src/fiddle.h src/feh.h src/yuk.h
BUILD = Makefile.in Makefile configure.ac configure config.h.in intercal.spec.in intercal.spec install.sh
MISC = etc/intercal.el src/coopt.sh
DOCS = BUGS.txt COPYING.txt NEWS.txt README.txt
SOURCES = $(CSOURCES) $(ISOURCES) $(YSOURCES) $(HEADERS) $(BUILD) $(MISC) $(DOCS) pit doc

all: bin/ick lib/libick.a lib/libickmt.a lib/libyuk.a ial

ial: src/fiddle.h src/abcess.h src/lose.h src/yuk.h src/ick-wrap.c src/pickwrap.c src/coopt.sh pit/lib/syslib.i
	-cp src/fiddle.h include/fiddle.h
	-cp src/abcess.h include/abcess.h
	-cp src/lose.h include/lose.h
	-cp src/yuk.h include/yuk.h
	-cp pit/lib/syslib.i pit/lib/syslib.?i include
	-cp src/ick-wrap.c lib/ick-wrap.c
	-cp src/pickwrap.c lib/pickwrap.c
	-cp src/coopt.sh lib/coopt.sh

copycopy: COPYING.txt
	-mkdir $(DESTDIR)$(datadir)
	-if cp $(copyloc) /dev/null ; then : ; else cp COPYING.txt $(copyloc) ; fi

checkcopy:
	@echo If the following line fails, change \"copyloc\" in your makefile.
	cp $(copyloc) /dev/null

bin/ick: temp/parser.o temp/lexer.o temp/feh2.o temp/dekludge.o temp/lose.o temp/fiddle.o temp/perpet.o
	$(CC) temp/perpet.o temp/ick.o temp/lexer.o temp/feh2.o temp/dekludge.o temp/lose.o temp/fiddle.o $(LDFLAGS) -o bin/ick

temp/parser.h temp/parser.c: src/parser.y src/ick.h src/sizes.h src/feh.h src/lose.h
	$(YACC) -d $(YACCFLAGS) src/parser.y
	-rm temp/parser.c
	mv y.tab.c temp/parser.c
	-rm temp/parser.h
	mv y.tab.h temp/parser.h

temp/lexer.c: src/lexer.l src/ick.h src/lose.h
	$(LEX) $(LEXFLAGS) src/lexer.l
	-rm temp/lexer.c
	mv lex.yy.c temp/lexer.c 

# Uncomment the following if using a stock lex
# LEXLIBS = -ll
bin/lextest: temp/parser.h src/lexer.c src/ick.h temp/lose.o
	$(CC) -DMAIN src/lexer.c src/lose.o $(LEXLIBS) -o bin/lextest

temp/parser.o: temp/parser.c src/ick.h src/feh.h src/lose.h src/sizes.h
	$(CC) $(CFLAGS) -c -o temp/ick.o temp/parser.c
temp/lexer.o: temp/lexer.c temp/parser.h src/ick.h src/lose.h
	$(CC) $(CFLAGS) -c -o temp/lexer.o temp/lexer.c
temp/feh2.o: src/feh2.c src/feh.h temp/parser.h src/ick.h src/fiddle.h src/lose.h src/sizes.h
	$(CC) $(CFLAGS) -c -o temp/feh2.o src/feh2.c
temp/dekludge.o: src/dekludge.c src/feh.h temp/parser.h src/ick.h src/fiddle.h src/lose.h src/sizes.h
	$(CC) $(CFLAGS) -c -o temp/dekludge.o src/dekludge.c
temp/perpet.o: src/perpet.c temp/parser.h src/ick.h src/lose.h src/sizes.h
	$(CC) $(CFLAGS) -c -o temp/perpet.o src/perpet.c
temp/cesspool.o: src/cesspool.c src/abcess.h src/lose.h src/sizes.h
	$(CC) $(CFLAGS) -c -o temp/cesspool.o src/cesspool.c
temp/numerals.o: src/numerals.c src/abcess.h src/lose.h src/sizes.h
	$(CC) $(CFLAGS) -c -o temp/numerals.o src/numerals.c
temp/unravel.o: src/unravel.c src/abcess.h src/lose.h src/sizes.h
	$(CC) $(CFLAGS) -c -o temp/unravel.o src/unravel.c
temp/lose.o: src/lose.c src/lose.h
	$(CC) $(CFLAGS) -c -o temp/lose.o src/lose.c
temp/fiddle.o: src/fiddle.c src/fiddle.h src/sizes.h
	$(CC) $(CFLAGS) -c -o temp/fiddle.o src/fiddle.c
temp/arrgghh.o: src/arrgghh.c
	$(CC) $(CFLAGS) -c -o temp/arrgghh.o src/arrgghh.c
temp/yuk.o: checkcopy src/yuk.h src/lose.h src/sizes.h src/abcess.h
	$(CC) $(CFLAGS) -c -o temp/yuk.o src/yuk.c

lib/libick.a: temp/cesspool.o temp/numerals.o temp/lose.o temp/fiddle.o temp/arrgghh.o
	ar cr lib/libick.a temp/cesspool.o temp/numerals.o temp/lose.o temp/fiddle.o temp/arrgghh.o
	-ranlib lib/libick.a

lib/libickmt.a: temp/cesspool.o temp/numerals.o temp/unravel.o temp/lose.o temp/fiddle.o temp/arrgghh.o
	ar cr lib/libickmt.a temp/cesspool.o temp/numerals.o temp/unravel.o temp/lose.o temp/fiddle.o temp/arrgghh.o
	-ranlib libickmt.a

lib/libyuk.a: temp/yuk.o
	ar cr lib/libyuk.a temp/yuk.o
	-ranlib lib/libyuk.a

install: copycopy all
	cp bin/ick $(DESTDIR)$(bindir)
	cp lib/libick.a $(DESTDIR)$(libdir)
	cp lib/libickmt.a $(DESTDIR)$(libdir)
	cp lib/libyuk.a $(DESTDIR)$(libdir)
	-mkdir -p $(DESTDIR)$(incdir)
	cp src/lose.h src/abcess.h src/fiddle.h src/yuk.h $(DESTDIR)$(incdir)
	-mkdir $(DESTDIR)$(datadir)
	(cp -r pit $(DESTDIR)$(datadir))
	cp src/ick-wrap.c $(DESTDIR)$(datadir)
	cp etc/coopt.sh $(DESTDIR)$(bindir)

uninstall:
	rm -f $(DESTDIR)$(bindir)/ick $(DESTDIR)$(libdir)/libick.a
	rm -f $(DESTDIR)$(bindir)/coopt.sh
	rm -f $(DESTDIR)$(libdir)/libickmt.a $(DESTDIR)$(libdir)/libyuk.a
	rm -fr $(DESTDIR)$(incdir) $(DESTDIR)$(datadir)

TAGS: $(SOURCES)
	etags $(SOURCES)

dist: ick-@PACKAGE_VERSION@.tgz

ick-@PACKAGE_VERSION@.tgz: $(SOURCES)
	@find $(SOURCES) -type f -print | grep -v RCS | sed s:^:ick-@PACKAGE_VERSION@/: >MANIFEST.txt
	@(cd ..; ln -s intercal ick-@PACKAGE_VERSION@)
	(cd ..; tar -czvf intercal/ick-@PACKAGE_VERSION@.tgz `cat intercal/MANIFEST.txt`)
	@(cd ..; rm ick-@PACKAGE_VERSION@)

clean:
	rm -f temp/* bin/* lib/* include/*

distr:
	rm -f temp/*.o bin/* lib/* include/*
